<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI å¯¹è¯å’¨è¯¢ - SalaryHelper</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="app-header-content">
        <a href="index.html" class="app-logo">
          âš–ï¸ SalaryHelper
        </a>
        <div class="user-info">
          <span id="userName" class="text-secondary">åŠ è½½ä¸­...</span>
          <button id="logoutBtn" class="btn btn-sm btn-ghost">é€€å‡º</button>
        </div>
      </div>
    </header>

    <div class="main-content">
      <div class="container-wide">
        <div id="conversationListView">
          <div class="flex justify-between items-center mb-lg">
            <div>
              <h2 class="mb-0">æˆ‘çš„ä¼šè¯</h2>
              <p class="text-secondary mt-sm">ä¸æ™ºèƒ½åŠ©æ‰‹çš„å¯¹è¯è®°å½•</p>
            </div>
            <button id="newConvBtn" class="btn btn-primary">
              â• æ–°å»ºä¼šè¯
            </button>
          </div>

          <div id="loadingState" class="loading">
            <div class="loading-spinner"></div>
            <div>åŠ è½½ä¸­...</div>
          </div>

          <div id="conversationList" class="conversation-list hidden"></div>

          <div id="emptyState" class="empty-state hidden">
            <div class="empty-state-icon">ğŸ’¬</div>
            <div class="empty-state-title">æš‚æ— ä¼šè¯</div>
            <div class="empty-state-text">ç‚¹å‡»"æ–°å»ºä¼šè¯"æŒ‰é’®å¼€å§‹ä¸AIåŠ©æ‰‹å¯¹è¯</div>
            <button class="btn btn-primary" onclick="document.getElementById('newConvBtn').click()">
              ç«‹å³å¼€å§‹
            </button>
          </div>
        </div>

        <div id="chatView" class="hidden">
          <div class="flex justify-between items-center mb-lg">
            <button id="backToList" class="btn btn-ghost">
              â† è¿”å›åˆ—è¡¨
            </button>
            <button id="deleteConvBtn" class="btn btn-sm btn-danger">
              åˆ é™¤ä¼šè¯
            </button>
          </div>

          <div class="card chat-container">
            <div class="chat-header">
              <h3 id="chatTitle" class="mb-0">ä¼šè¯</h3>
              <div class="badge badge-success">AI åœ¨çº¿</div>
            </div>

            <div id="chatMessages" class="chat-messages"></div>

            <div class="chat-input">
              <textarea 
                id="messageInput" 
                class="form-control"
                placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                rows="2"
                style="resize: none;"
              ></textarea>
              <button id="sendBtn" class="btn btn-primary">
                å‘é€
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="api-client-real.js"></script>
  <script>
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const newConvBtn = document.getElementById('newConvBtn');
    const conversationListView = document.getElementById('conversationListView');
    const chatView = document.getElementById('chatView');
    const loadingState = document.getElementById('loadingState');
    const conversationList = document.getElementById('conversationList');
    const emptyState = document.getElementById('emptyState');
    const backToList = document.getElementById('backToList');
    const chatTitle = document.getElementById('chatTitle');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const deleteConvBtn = document.getElementById('deleteConvBtn');
    
    let currentConvId = null;
    let conversations = [];
    
    function checkLoginStatus() {
      if (!ApiClient.isLoggedIn()) {
        window.location.href = '/static/login.html';
        return false;
      }
      return true;
    }
    
    async function updateUserInfo() {
      if (!checkLoginStatus()) return;
      
      try {
        const user = ApiClient.getCurrentUserSync();
        if (user) {
          userName.textContent = user.name || user.phone;
        }
      } catch (error) {
        console.error('Error updating user info:', error);
      }
    }
    
    async function loadConversations() {
      if (!checkLoginStatus()) return;
      
      loadingState.classList.remove('hidden');
      conversationList.classList.add('hidden');
      emptyState.classList.add('hidden');
      
      try {
        conversations = await ApiClient.listConversations();
        
        if (conversations.length === 0) {
          emptyState.classList.remove('hidden');
        } else {
          renderConversations();
          conversationList.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Failed to load conversations:', error);
        conversationList.innerHTML = `
          <div class="alert alert-error">
            <span>âš ï¸</span>
            <div>åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥: ${error.message}</div>
          </div>
        `;
        conversationList.classList.remove('hidden');
      } finally {
        loadingState.classList.add('hidden');
      }
    }
    
    function renderConversations() {
      conversationList.innerHTML = conversations.map(conv => `
        <div class="conversation-item" data-id="${conv.id}">
          <div class="conversation-title">${conv.title || 'æœªå‘½åä¼šè¯'}</div>
          <div class="conversation-meta">
            <span>ğŸ“… ${new Date(conv.created_at).toLocaleString('zh-CN')}</span>
          </div>
        </div>
      `).join('');
      
      conversationList.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', () => {
          const convId = item.dataset.id;
          const conv = conversations.find(c => c.id === convId);
          openConversation(convId, conv.title);
        });
      });
    }
    
    async function createConversation() {
      if (!checkLoginStatus()) return;
      
      const title = prompt('è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰:', `å’¨è¯¢ - ${new Date().toLocaleString('zh-CN')}`);
      if (title === null) return;
      
      try {
        newConvBtn.disabled = true;
        newConvBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> åˆ›å»ºä¸­...';
        
        const conv = await ApiClient.createConversation(title);
        await openConversation(conv.id, conv.title);
      } catch (error) {
        console.error('Failed to create conversation:', error);
        alert('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message);
      } finally {
        newConvBtn.disabled = false;
        newConvBtn.innerHTML = 'â• æ–°å»ºä¼šè¯';
      }
    }
    
    async function openConversation(convId, title) {
      if (!checkLoginStatus()) return;
      
      currentConvId = convId;
      chatTitle.textContent = title || 'ä¼šè¯';
      
      conversationListView.classList.add('hidden');
      chatView.classList.remove('hidden');
      
      chatMessages.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>åŠ è½½æ¶ˆæ¯...</div></div>';
      
      try {
        const data = await ApiClient.getConversation(convId);
        renderMessages(data.messages || []);
      } catch (error) {
        console.error('Failed to load conversation:', error);
        chatMessages.innerHTML = `
          <div class="alert alert-error">
            <span>âš ï¸</span>
            <div>åŠ è½½æ¶ˆæ¯å¤±è´¥: ${error.message}</div>
          </div>
        `;
      }
      
      messageInput.focus();
    }
    
    function renderMessages(messages) {
      if (messages.length === 0) {
        chatMessages.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘‹</div>
            <div class="empty-state-title">å¼€å§‹å¯¹è¯</div>
            <div class="empty-state-text">æ‚¨å¥½ï¼æˆ‘æ˜¯åŠ³åŠ¨æ³•æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</div>
          </div>
        `;
        return;
      }
      
      chatMessages.innerHTML = messages.map(msg => {
        const isUser = msg.sender === 'user';
        const time = new Date(msg.created_at).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        
        return `
          <div class="message-bubble ${msg.sender}">
            <div class="message-avatar">${isUser ? 'æˆ‘' : 'AI'}</div>
            <div class="message-content">
              <div class="message-meta">${isUser ? 'æˆ‘' : 'AIåŠ©æ‰‹'} Â· ${time}</div>
              <div class="message-text">${msg.content}</div>
            </div>
          </div>
        `;
      }).join('');
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    async function sendMessage() {
      if (!checkLoginStatus() || !currentConvId) return;
      
      const text = messageInput.value.trim();
      if (!text) return;
      
      const originalText = text;
      messageInput.value = '';
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div>';
      
      try {
        await ApiClient.sendMessage(currentConvId, text);
        
        const data = await ApiClient.getConversation(currentConvId);
        renderMessages(data.messages || []);
        
      } catch (error) {
        console.error('Failed to send message:', error);
        alert('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message);
        messageInput.value = originalText;
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = 'å‘é€';
        messageInput.focus();
      }
    }
    
    async function deleteConversation() {
      if (!currentConvId) return;
      
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }
      
      try {
        currentConvId = null;
        conversationListView.classList.remove('hidden');
        chatView.classList.add('hidden');
        alert('ä¼šè¯å·²åˆ é™¤ï¼ˆæ¨¡æ‹Ÿï¼‰');
        await loadConversations();
      } catch (error) {
        console.error('Failed to delete conversation:', error);
        alert('åˆ é™¤ä¼šè¯å¤±è´¥: ' + error.message);
      }
    }
    
    function backToConversationList() {
      currentConvId = null;
      conversationListView.classList.remove('hidden');
      chatView.classList.add('hidden');
      loadConversations();
    }
    
    sendBtn.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    newConvBtn.addEventListener('click', createConversation);
    backToList.addEventListener('click', backToConversationList);
    deleteConvBtn.addEventListener('click', deleteConversation);
    
    logoutBtn.addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        ApiClient.logout();
        window.location.href = '/static/login.html';
      }
    });
    
    if (checkLoginStatus()) {
      updateUserInfo();
      loadConversations();
    }
  </script>
</body>
</html>
