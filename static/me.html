<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç”¨æˆ·ä¸­å¿ƒ - SalaryHelper</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="app-header-content">
        <a href="index.html" class="app-logo">
          âš–ï¸ SalaryHelper
        </a>
        <div class="user-info">
          <span id="userName" class="text-secondary">åŠ è½½ä¸­...</span>
          <button id="logoutBtn" class="btn btn-sm btn-danger">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </header>

    <div class="main-content">
      <div class="container-wide">
        <div class="flex justify-between items-center mb-lg">
          <div>
            <h2 class="mb-0">ç”¨æˆ·ä¸­å¿ƒ</h2>
            <p class="text-secondary mt-sm">ç®¡ç†ä¸ªäººä¿¡æ¯å’Œè´¦æˆ·è®¾ç½®</p>
          </div>
          <a href="index.html" class="btn btn-ghost">
            â† è¿”å›é¦–é¡µ
          </a>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;" class="user-center-container">
          <div>
            <div class="card mb-lg">
              <div class="card-header">
                <h3 class="card-title">ä¸ªäººä¿¡æ¯</h3>
                <button id="editProfileBtn" class="btn btn-sm btn-outline">ç¼–è¾‘</button>
              </div>
              <div class="card-body" id="profileInfo">
                <div class="loading">
                  <div class="loading-spinner"></div>
                  <div>åŠ è½½ä¸­...</div>
                </div>
              </div>
            </div>

            <div class="card mb-lg">
              <div class="card-header">
                <h3 class="card-title">æˆ‘çš„è®¢å•</h3>
                <a href="payment.html" class="btn btn-sm btn-outline">æŸ¥çœ‹å…¨éƒ¨</a>
              </div>
              <div class="card-body">
                <div id="ordersList"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æˆ‘çš„æ–‡æ¡£</h3>
                <a href="docgen.html" class="btn btn-sm btn-outline">ç”Ÿæˆæ–‡æ¡£</a>
              </div>
              <div class="card-body">
                <div id="documentsList"></div>
              </div>
            </div>
          </div>

          <div>
            <div class="card mb-lg">
              <h3 class="card-title">è´¦æˆ·ç»Ÿè®¡</h3>
              <div class="stat-card" style="border: none; box-shadow: none; padding: 12px 0;">
                <div class="stat-label">ä¼šè¯æ€»æ•°</div>
                <div class="stat-value" id="conversationCount" style="font-size: 28px;">-</div>
              </div>
              <div class="stat-card" style="border: none; box-shadow: none; padding: 12px 0;">
                <div class="stat-label">æ–‡ä¹¦æ€»æ•°</div>
                <div class="stat-value" id="documentCount" style="font-size: 28px;">-</div>
              </div>
              <div class="stat-card" style="border: none; box-shadow: none; padding: 12px 0;">
                <div class="stat-label">è®¢å•æ€»æ•°</div>
                <div class="stat-value" id="orderCount" style="font-size: 28px;">-</div>
              </div>
            </div>

            <div class="card">
              <h3 class="card-title">å¿«æ·æ“ä½œ</h3>
              <div class="flex flex-col gap-sm">
                <a href="conversations.html" class="btn btn-outline btn-block">
                  ğŸ’¬ æˆ‘çš„ä¼šè¯
                </a>
                <a href="docgen.html" class="btn btn-outline btn-block">
                  ğŸ“„ ç”Ÿæˆæ–‡ä¹¦
                </a>
                <a href="payment.html" class="btn btn-outline btn-block">
                  ğŸ’³ å……å€¼ä»˜è´¹
                </a>
                <a href="evidence.html" class="btn btn-outline btn-block">
                  ğŸ“ è¯æ®ç®¡ç†
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="api-client-real.js"></script>
  <script>
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const profileInfo = document.getElementById('profileInfo');
    const ordersList = document.getElementById('ordersList');
    const documentsList = document.getElementById('documentsList');
    const conversationCount = document.getElementById('conversationCount');
    const documentCount = document.getElementById('documentCount');
    const orderCount = document.getElementById('orderCount');
    
    function checkLoginStatus() {
      if (!ApiClient.isLoggedIn()) {
        window.location.href = '/static/login.html';
        return false;
      }
      return true;
    }
    
    async function loadUserProfile() {
      if (!checkLoginStatus()) return;
      
      try {
        const user = await ApiClient.getCurrentUser();
        
        userName.textContent = user.name || user.phone;
        
        profileInfo.innerHTML = `
          <div style="display: flex; gap: 24px; align-items: center; margin-bottom: 24px;">
            <div class="user-avatar" style="width: 80px; height: 80px; font-size: 32px;">
              ${(user.name || user.phone).charAt(0)}
            </div>
            <div>
              <h3 class="mb-sm">${user.name || 'æœªè®¾ç½®æ˜µç§°'}</h3>
              <div class="text-secondary">æ‰‹æœºå·: ${user.phone}</div>
              <div class="text-secondary">ID: ${user.id}</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div>
              <div class="form-label">æ³¨å†Œæ—¶é—´</div>
              <div>${new Date(user.created_at).toLocaleString('zh-CN')}</div>
            </div>
            <div>
              <div class="form-label">è´¦æˆ·çŠ¶æ€</div>
              <div><span class="badge badge-success">æ­£å¸¸</span></div>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Failed to load user profile:', error);
        profileInfo.innerHTML = `
          <div class="alert alert-error">
            <span>âš ï¸</span>
            <div>åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}</div>
          </div>
        `;
      }
    }
    
    async function loadOrders() {
      if (!checkLoginStatus()) return;
      
      try {
        const orders = await ApiClient.listOrders();
        
        if (orders.length === 0) {
          ordersList.innerHTML = '<div class="empty-state" style="padding: 32px;"><div class="text-secondary">æš‚æ— è®¢å•</div></div>';
          return;
        }
        
        const recentOrders = orders.slice(0, 3);
        
        ordersList.innerHTML = recentOrders.map(order => `
          <div style="padding: 12px; border-bottom: 1px solid var(--border-color);">
            <div class="flex justify-between items-center mb-sm">
              <div style="font-weight: 600;">${order.product_type || 'æœåŠ¡'}</div>
              <div class="badge ${order.status === 'paid' ? 'badge-success' : 'badge-warning'}">
                ${order.status === 'paid' ? 'å·²æ”¯ä»˜' : order.status === 'pending' ? 'å¾…æ”¯ä»˜' : order.status}
              </div>
            </div>
            <div class="text-secondary" style="font-size: 13px;">
              <div>é‡‘é¢: Â¥${order.amount.toFixed(2)}</div>
              <div>æ—¶é—´: ${new Date(order.created_at).toLocaleString('zh-CN')}</div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Failed to load orders:', error);
        ordersList.innerHTML = '<div class="text-secondary text-center p-lg">åŠ è½½å¤±è´¥</div>';
      }
    }
    
    async function loadDocuments() {
      if (!checkLoginStatus()) return;
      
      try {
        const documents = await ApiClient.listDocuments();
        
        if (documents.length === 0) {
          documentsList.innerHTML = '<div class="empty-state" style="padding: 32px;"><div class="text-secondary">æš‚æ— æ–‡æ¡£</div></div>';
          return;
        }
        
        const recentDocs = documents.slice(0, 3);
        
        documentsList.innerHTML = recentDocs.map(doc => `
          <div style="padding: 12px; border-bottom: 1px solid var(--border-color);">
            <div class="flex justify-between items-center mb-sm">
              <div style="font-weight: 600;">${doc.title || 'æœªå‘½åæ–‡æ¡£'}</div>
              <div class="badge ${doc.status === 'completed' ? 'badge-success' : 'badge-warning'}">
                ${doc.status === 'completed' ? 'å·²å®Œæˆ' : doc.status}
              </div>
            </div>
            <div class="text-secondary" style="font-size: 13px;">
              ${new Date(doc.created_at).toLocaleString('zh-CN')}
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Failed to load documents:', error);
        documentsList.innerHTML = '<div class="text-secondary text-center p-lg">åŠ è½½å¤±è´¥</div>';
      }
    }
    
    async function loadStats() {
      if (!checkLoginStatus()) return;
      
      try {
        const [conversations, documents, orders] = await Promise.all([
          ApiClient.listConversations().catch(() => []),
          ApiClient.listDocuments().catch(() => []),
          ApiClient.listOrders().catch(() => [])
        ]);
        
        conversationCount.textContent = conversations.length;
        documentCount.textContent = documents.length;
        orderCount.textContent = orders.length;
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }
    
    editProfileBtn.addEventListener('click', () => {
      alert('ä¸ªäººä¿¡æ¯ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
    });
    
    logoutBtn.addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        ApiClient.logout();
        window.location.href = '/static/login.html';
      }
    });
    
    if (checkLoginStatus()) {
      loadUserProfile();
      loadOrders();
      loadDocuments();
      loadStats();
    }
    
    if (window.innerWidth <= 768) {
      document.querySelector('.user-center-container').style.gridTemplateColumns = '1fr';
    }
  </script>
</body>
</html>
