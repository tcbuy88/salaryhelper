<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ–‡ä¹¦ç”Ÿæˆ - SalaryHelper</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="app-header-content">
        <a href="index.html" class="app-logo">
          âš–ï¸ SalaryHelper
        </a>
        <div class="user-info">
          <span id="userName" class="text-secondary">åŠ è½½ä¸­...</span>
          <button id="logoutBtn" class="btn btn-sm btn-ghost">é€€å‡º</button>
        </div>
      </div>
    </header>

    <div class="main-content">
      <div class="container-wide">
        <div class="flex justify-between items-center mb-lg">
          <div>
            <h2 class="mb-0">æ–‡ä¹¦ç”Ÿæˆ</h2>
            <p class="text-secondary mt-sm">é€‰æ‹©æ¨¡æ¿å¿«é€Ÿç”ŸæˆåŠ³åŠ¨æ³•ç›¸å…³æ–‡ä¹¦</p>
          </div>
          <a href="index.html" class="btn btn-ghost">
            â† è¿”å›é¦–é¡µ
          </a>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;" class="doc-gen-container">
          <div>
            <div class="card">
              <h3 class="card-title">é€‰æ‹©æ¨¡æ¿</h3>
              <div id="templateCategories"></div>
              <div id="templateList" class="mt-lg"></div>
            </div>
          </div>

          <div>
            <div id="templateForm" class="card hidden">
              <div class="card-header">
                <h3 class="card-title" id="templateName">æ¨¡æ¿è¡¨å•</h3>
                <div class="badge badge-primary" id="templateCategory"></div>
              </div>
              <div class="card-body">
                <div id="templateDescription" class="text-secondary mb-lg"></div>
                <form id="docForm">
                  <div id="formFields"></div>
                  <div class="btn-group mt-xl">
                    <button type="button" id="previewBtn" class="btn btn-secondary">
                      ğŸ‘ï¸ é¢„è§ˆ
                    </button>
                    <button type="submit" class="btn btn-primary">
                      ğŸ“„ ç”Ÿæˆæ–‡æ¡£
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <div id="documentPreview" class="card hidden">
              <div class="card-header">
                <h3 class="card-title">æ–‡æ¡£é¢„è§ˆ</h3>
                <button id="closePreview" class="btn btn-sm btn-ghost">å…³é—­</button>
              </div>
              <div class="card-body">
                <div id="previewContent" style="white-space: pre-wrap; line-height: 1.8; padding: 20px; background: #f9fafb; border-radius: 8px;"></div>
                <div class="mt-lg btn-group">
                  <button id="downloadBtn" class="btn btn-success">
                    â¬‡ï¸ ä¸‹è½½æ–‡æ¡£
                  </button>
                  <button id="editBtn" class="btn btn-secondary">
                    âœï¸ ç»§ç»­ç¼–è¾‘
                  </button>
                </div>
              </div>
            </div>

            <div id="emptyState" class="card">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“„</div>
                <div class="empty-state-title">é€‰æ‹©æ¨¡æ¿å¼€å§‹</div>
                <div class="empty-state-text">ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ–‡ä¹¦æ¨¡æ¿ï¼Œå¡«å†™ä¿¡æ¯åå³å¯ç”Ÿæˆæ–‡æ¡£</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="api-client-real.js"></script>
  <script>
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const templateList = document.getElementById('templateList');
    const templateCategories = document.getElementById('templateCategories');
    const templateForm = document.getElementById('templateForm');
    const templateName = document.getElementById('templateName');
    const templateCategory = document.getElementById('templateCategory');
    const templateDescription = document.getElementById('templateDescription');
    const formFields = document.getElementById('formFields');
    const docForm = document.getElementById('docForm');
    const previewBtn = document.getElementById('previewBtn');
    const documentPreview = document.getElementById('documentPreview');
    const previewContent = document.getElementById('previewContent');
    const closePreview = document.getElementById('closePreview');
    const downloadBtn = document.getElementById('downloadBtn');
    const editBtn = document.getElementById('editBtn');
    const emptyState = document.getElementById('emptyState');
    
    let templates = [];
    let currentTemplate = null;
    let currentDocument = null;
    
    function checkLoginStatus() {
      if (!ApiClient.isLoggedIn()) {
        window.location.href = '/static/login.html';
        return false;
      }
      return true;
    }
    
    async function updateUserInfo() {
      if (!checkLoginStatus()) return;
      
      try {
        const user = ApiClient.getCurrentUserSync();
        if (user) {
          userName.textContent = user.name || user.phone;
        }
      } catch (error) {
        console.error('Error updating user info:', error);
      }
    }
    
    async function loadTemplates() {
      if (!checkLoginStatus()) return;
      
      try {
        templates = await ApiClient.listTemplates();
        
        const categories = [...new Set(templates.map(t => t.category || 'å…¶ä»–'))];
        
        templateCategories.innerHTML = `
          <div class="form-group">
            <label class="form-label">æ–‡ä¹¦ç±»åˆ«</label>
            <select id="categoryFilter" class="form-control">
              <option value="">å…¨éƒ¨</option>
              ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
          </div>
        `;
        
        document.getElementById('categoryFilter').addEventListener('change', (e) => {
          renderTemplates(e.target.value);
        });
        
        renderTemplates();
        
      } catch (error) {
        console.error('Failed to load templates:', error);
        templateList.innerHTML = `
          <div class="alert alert-error">
            <span>âš ï¸</span>
            <div>åŠ è½½æ¨¡æ¿å¤±è´¥: ${error.message}</div>
          </div>
        `;
      }
    }
    
    function renderTemplates(categoryFilter = '') {
      const filtered = categoryFilter 
        ? templates.filter(t => t.category === categoryFilter)
        : templates;
      
      if (filtered.length === 0) {
        templateList.innerHTML = '<div class="text-secondary text-center p-lg">æš‚æ— æ¨¡æ¿</div>';
        return;
      }
      
      templateList.innerHTML = filtered.map(tpl => `
        <div class="card mb-sm" style="padding: 12px; cursor: pointer;" data-id="${tpl.id}">
          <div style="font-weight: 600; margin-bottom: 4px;">${tpl.name}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">${tpl.description || ''}</div>
        </div>
      `).join('');
      
      templateList.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', () => {
          const tplId = card.dataset.id;
          selectTemplate(tplId);
        });
      });
    }
    
    async function selectTemplate(tplId) {
      try {
        currentTemplate = await ApiClient.getTemplate(tplId);
        
        templateName.textContent = currentTemplate.name;
        templateCategory.textContent = currentTemplate.category || 'å…¶ä»–';
        templateDescription.textContent = currentTemplate.description || '';
        
        renderForm(currentTemplate);
        
        emptyState.classList.add('hidden');
        documentPreview.classList.add('hidden');
        templateForm.classList.remove('hidden');
        
      } catch (error) {
        console.error('Failed to load template:', error);
        alert('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + error.message);
      }
    }
    
    function renderForm(template) {
      const fields = Array.isArray(template.fields) ? template.fields : [];
      
      if (fields.length === 0) {
        formFields.innerHTML = '<div class="alert alert-warning"><span>âš ï¸</span><div>æ­¤æ¨¡æ¿æ²¡æœ‰å¯å¡«å†™çš„å­—æ®µ</div></div>';
        return;
      }
      
      formFields.innerHTML = fields.map(field => {
        const fieldName = typeof field === 'string' ? field : field.name;
        const fieldLabel = typeof field === 'object' && field.label ? field.label : fieldName;
        const fieldType = typeof field === 'object' && field.type ? field.type : 'text';
        
        return `
          <div class="form-group">
            <label class="form-label" for="field_${fieldName}">${fieldLabel}</label>
            ${fieldType === 'textarea' 
              ? `<textarea id="field_${fieldName}" name="${fieldName}" class="form-control" rows="4"></textarea>`
              : `<input type="${fieldType}" id="field_${fieldName}" name="${fieldName}" class="form-control" />`
            }
          </div>
        `;
      }).join('');
    }
    
    function getFormData() {
      const formData = new FormData(docForm);
      const data = {};
      for (const [key, value] of formData.entries()) {
        data[key] = value;
      }
      return data;
    }
    
    async function previewDocument() {
      if (!currentTemplate) return;
      
      const formData = getFormData();
      
      try {
        previewBtn.disabled = true;
        previewBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> ç”Ÿæˆä¸­...';
        
        const result = await ApiClient.generateDocument(currentTemplate.id, 'preview', formData);
        
        currentDocument = result;
        
        previewContent.textContent = result.content || 'æ— å†…å®¹';
        
        templateForm.classList.add('hidden');
        documentPreview.classList.remove('hidden');
        
      } catch (error) {
        console.error('Failed to preview document:', error);
        alert('é¢„è§ˆå¤±è´¥: ' + error.message);
      } finally {
        previewBtn.disabled = false;
        previewBtn.innerHTML = 'ğŸ‘ï¸ é¢„è§ˆ';
      }
    }
    
    async function generateDocument(e) {
      e.preventDefault();
      
      if (!currentTemplate) return;
      
      const formData = getFormData();
      const title = `${currentTemplate.name} - ${new Date().toLocaleDateString()}`;
      
      try {
        const submitBtn = e.submitter;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> ç”Ÿæˆä¸­...';
        
        const result = await ApiClient.generateDocument(currentTemplate.id, title, formData);
        
        currentDocument = result;
        
        previewContent.textContent = result.content || 'æ— å†…å®¹';
        
        templateForm.classList.add('hidden');
        documentPreview.classList.remove('hidden');
        
        alert('æ–‡æ¡£ç”ŸæˆæˆåŠŸï¼');
        
      } catch (error) {
        console.error('Failed to generate document:', error);
        alert('ç”Ÿæˆæ–‡æ¡£å¤±è´¥: ' + error.message);
      } finally {
        const submitBtn = e.submitter;
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸ“„ ç”Ÿæˆæ–‡æ¡£';
      }
    }
    
    function downloadDocument() {
      if (!currentDocument) return;
      
      const blob = new Blob([currentDocument.content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentDocument.title || 'document'}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    previewBtn.addEventListener('click', previewDocument);
    docForm.addEventListener('submit', generateDocument);
    
    closePreview.addEventListener('click', () => {
      documentPreview.classList.add('hidden');
      templateForm.classList.remove('hidden');
    });
    
    editBtn.addEventListener('click', () => {
      documentPreview.classList.add('hidden');
      templateForm.classList.remove('hidden');
    });
    
    downloadBtn.addEventListener('click', downloadDocument);
    
    logoutBtn.addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        ApiClient.logout();
        window.location.href = '/static/login.html';
      }
    });
    
    if (checkLoginStatus()) {
      updateUserInfo();
      loadTemplates();
    }
    
    if (window.innerWidth <= 768) {
      document.querySelector('.doc-gen-container').style.gridTemplateColumns = '1fr';
    }
  </script>
</body>
</html>
